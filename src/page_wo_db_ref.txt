<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
  crossorigin="anonymous"
/>

<link rel="stylesheet" href="../SiteAssets/wo/app.css" />
<link
  rel="stylesheet"
  href="../SiteAssets/workorder/vendor/fontawesome-5.9.0/css/all.min.css"
/>

<div id="app">
  <ul class="nav nav-tabs" id="section-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="my-requests-tab"
        data-bs-toggle="tab"
        data-bs-target="#my-requests"
        data-bind="click: TabClicked"
        type="button"
        role="tab"
        aria-controls="my-requests"
        aria-selected="true"
      >
        My Orders
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="new-request-tab"
        data-bs-toggle="tab"
        data-bs-target="#new-request"
        data-bind="click: TabClicked"
        type="button"
        role="tab"
        aria-controls="new-request"
        aria-selected="true"
      >
        New Order
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="request-detail-tab"
        data-bs-toggle="tab"
        data-bs-target="#request-detail"
        data-bind="click: TabClicked"
        type="button"
        role="tab"
        aria-controls="request-detail"
        aria-selected="false"
      >
        Detail View
      </button>
    </li>
  </ul>
  <div class="tab-content">
    <div
      class="tab-pane"
      role="tabpanel"
      aria-labelledby="my-requests-tab"
      id="my-requests"
    >
      <div
        data-bind="template: {name: 'tmpl-my-requests-view', data: MyRequestsView}"
      ></div>
    </div>
    <div
      class="tab-pane"
      role="tabpanel"
      aria-labelledby="new-request"
      id="new-request"
    >
      <div
        data-bind="template: {name: 'tmpl-new-request-view', data: NewRequestView}"
      ></div>
    </div>
    <div
      id="request-detail"
      class="tab-pane"
      role="tabpanel"
      aria-labelledby="request-detail-tab"
    >
      <!-- ko ifnot: RequestDetailView -->
      <div class="container">
        <h2>Service Request Detail</h2>
        <div>Please create a new request, or open an existing request.</div>
      </div>
      <!-- /ko -->
      <!-- ko if: RequestDetailView -->
      <div
        data-bind="template: {name: 'tmpl-request-detail', data: RequestDetailView}"
      ></div>
      <!-- /ko -->
    </div>
  </div>
  <div id="service-type-templates"></div>

  <div id="tmpl-views">
    <script type="text/html" id="tmpl-my-requests-view">
      <h2>My Requests</h2>
      <div class="d-flex">
        <div class="list-group me-3" id="section-my-requests-tabs">
          <button
            class="list-group-item list-group-action"
            id="my-open-requests-tab"
            data-target="open"
            data-bind="click: viewTabClicked, 
            css: {'active': views.open == View()}"
            type="button"
          >
            Open
          </button>
          <button
            class="list-group-item list-group-action"
            id="my-closed-requests-tab"
            data-target="closed"
            data-bind="click: viewTabClicked, 
            css: {'active': views.closed == View()}"
            type="button"
          >
            Closed
          </button>
          <button
            class="list-group-item list-group-action"
            id="my-cancelled-requests-tab"
            data-target="cancelled"
            data-bind="click: viewTabClicked, 
            css: {'active': views.cancelled == View()}"
            type="button"
          >
            Cancelled
          </button>
        </div>
        <div class="container">
          <!-- ko if: ActiveComponent -->
          <div
            data-bind="template: {name: ActiveComponent().TemplateId, data: ActiveComponent()} "
          ></div>
          <!-- /ko -->
        </div>
      </div>
    </script>

    <script type="text/html" id="tmpl-requests-by-status">
      <div class="d-flex justify-content-between">
        <h2 class="mx-0" data-bind="text: filter"></h2>
        <i class="fa fa-sync pointer" data-bind="click: refreshRequests"></i>
      </div>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Service Type</th>
            <th>Requesting Office</th>
            <th>Requestor</th>
            <th>Submitted Date</th>
            <th>Est. Completion Date</th>
          </tr>
        </thead>
        <!-- ko if: IsLoading -->
        <tbody>
          <tr>
            <td colspan="6">
              <div class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
        <!-- /ko -->
        <!-- ko ifnot: IsLoading -->
        <tbody data-bind="foreach: FilteredRequests">
          <tr class="pointer" data-bind="click: $root.ViewRequest">
            <td data-bind="text: Title"></td>
            <td data-bind="text: ServiceType?.Title"></td>
            <td data-bind="text: RequestorOrg?.Title"></td>
            <td data-bind="text: Requestor?.Title"></td>
            <td data-bind="text: RequestSubmitted?.toLocaleDateString()"></td>
            <td data-bind="text: EstClosedDate?.toLocaleDateString()"></td>
          </tr>
        </tbody>
        <!-- /ko -->
      </table>
    </script>

    <script type="text/html" id="tmpl-new-request-view">
      <h2>Select the type of work order you would like to open:</h2>
      <div class="container text-center">
        <div class="row row-cols-4" data-bind="foreach: ServiceTypeStore">
          <div class="col">
            <div class="card text-center" data-bind="click: $root.NewRequest">
              <div class="card-body">
                <i class="fa fa-5x" data-bind="class: Icon"></i>
              </div>
              <div class="card-body">
                <h5 class="card-title" data-bind="text: Title"></h5>
              </div>
            </div>
          </div>
        </div>
      </div>
    </script>

    <script type="text/html" id="tmpl-request-detail">
      <!-- Report.RequestDetailView -->
      <div class="container">
        <h2>Service Request Detail</h2>
        <div>
          <div class="sticky mb-3">
            <div
              class="card d-flex flex-row justify-content-between align-items-center px-2"
            >
              <div class="m-2">
                <h6 class="mb-1">
                  Request: <span data-bind="text: ObservableTitle"></span>
                </h6>
                <div class="d-flex align-items-center">
                  <div class="me-2">
                    Loaded:
                    <span data-bind="text: LoadedAt()?.toLocaleString()"></span>
                  </div>
                  <i
                    class="fa fa-sync pointer"
                    title="Refresh this request"
                    data-bind="click: refreshAll"
                  ></i>
                </div>
              </div>
              <div class="d-flex justify-content-between">
                <button
                  type="button"
                  class="btn btn-success ms-3"
                  data-bind="click: approveAll"
                >
                  Approve
                </button>
                <button
                  type="button"
                  class="btn btn-success ms-3"
                  data-bind="click: promptAdvance"
                >
                  Next Stage <span class="fa fa-chevron-right"></span>
                </button>
              </div>
            </div>
          </div>
          <!-- ko if: ServiceType -->
          <div
            class="mb-3"
            data-bind="template: {name: 'tmpl-request-pipeline', data: PipelineComponent}"
          ></div>
          <!-- /ko -->
          <!-- ko if: AssignmentsComponent -->
          <div
            class="mb-3"
            data-bind="template: {name: 'tmpl-assignments-component', data: AssignmentsComponent}"
          ></div>
          <!-- /ko -->
          <div data-bind="template: {name: 'tmpl-request-header'}"></div>
          <div
            data-bind="template: {name: 'tmpl-service-type-component'}"
          ></div>
          <div class="row mb-3">
            <div class="col-4">
              <div class="card">
                <div class="card-body">
                  <h3 class="card-title">Attachments</h3>
                  <!-- ko if: false -->
                  <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </div>
                  <!-- /ko -->
                </div>
              </div>
            </div>
            <div
              class="col-8"
              data-bind="template: {name: 'tmpl-activity-log-component', data: ActivityLog}"
            ></div>
          </div>
          <div class="card mb-3 w-100">
            <div class="card-body">
              <h3 class="card-title">Comments</h3>
              <!-- ko if: false -->
              <div class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <!-- /ko -->
              <textarea class="form-control"></textarea>
            </div>
          </div>
          <div>
            <!-- ko if: DisplayMode() -->
            <button type="button" data-bind="click: submitNewRequest">
              Submit
            </button>
            <!-- /ko -->
            <!-- ko if: DisplayMode() == DisplayModes.View -->
            <button type="button" data-bind="click: editRequestHandler">
              Edit
            </button>
            <!-- /ko -->
            <!-- ko if: DisplayMode() == DisplayModes.Edit -->
            <button type="button" data-bind="click: updateRequestHandler">
              Save Changes
            </button>
            <button type="button" data-bind="click: cancelChangesHandler">
              Cancel
            </button>
            <!-- /ko -->
          </div>
        </div>
      </div>
      <div
        class="modal fade"
        id="modal-advance-request"
        data-bs-backdrop="static"
        data-bs-keyboard="false"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="mx-0 modal-title fs-5" id="staticBackdropLabel">
                Modal title
              </h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <!-- ko if: AssignmentsComponent.InProgress().length -->
              This request still has
              <span
                data-bind="text: AssignmentsComponent.InProgress().length"
              ></span>
              open assignments.
              <!-- /ko -->
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-primary"
                data-bind="click: advanceRequest"
              >
                Advance
              </button>
            </div>
          </div>
        </div>
      </div>
    </script>

    <script type="text/html" id="tmpl-request-pipeline">
      <div class="row">
        <ol class="list-group-horizontal d-flex">
          <li class="list-group-item d-flex flex-column justify-content-center">
            <i class="fa fa-3x" data-bind="class: Icon"></i>
          </li>
          <!-- ko foreach: Stages -->
          <li
            class="list-group-item d-flex flex-column justify-content-center"
            data-bind="css: {'list-group-item-primary': Step == $parent.CurrentStage()?.Step,
            'list-group-item-secondary': Step < $parent.CurrentStage()?.Step}"
          >
            <div class="d-flex align-items-center">
              <h4 class="" data-bind="text: Step"></h4>
              <div class="mx-2"></div>
              <div>
                <div class="fw-bold" data-bind="text: Title"></div>
                <p data-bind="text: ActionType"></p>
              </div>
            </div>
          </li>
          <!-- /ko -->
        </ol>
      </div>
    </script>

    <script type="text/html" id="tmpl-assignments-component">
      <div class="card">
        <div class="card-body">
          <div class="card-title d-flex justify-content-between">
            <h3 class="mx-0">Routing and Assignment</h3>
            <i
              class="fa fa-sync pointer"
              data-bind="click: refreshAssignments"
            ></i>
          </div>
          <div class="position-relative">
            <div class="dimmer" data-bind="css: {'active': IsLoading}">
              <div
                class="d-flex flex-grow-1 align-items-center justify-content-center"
              >
                <div class="spinner-border text-white" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Stage</th>
                  <th>Assignee</th>
                  <th>Request Org</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- ko foreach: Assignments -->
                <tr>
                  <td data-bind="text: PipelineStage?.Title"></td>
                  <td data-bind="text: Assignee?.Title"></td>
                  <td data-bind="text: RequestOrg?.Title"></td>
                  <td data-bind="text: Role"></td>
                  <td data-bind="text: Status"></td>
                  <td>
                    <i
                      class="fa fa-trash pointer"
                      data-bind="click: $parent.removeAssignment"
                    ></i>
                  </td>
                </tr>
                <!-- /ko -->
              </tbody>
            </table>
          </div>
          <div class="input-group" data-bind="using: newAssignmentComponent">
            <span class="input-group-text">New Assignment</span>
            <div id="people-new-assignee" data-bind="people: Assignee"></div>
            <select
              name=""
              id=""
              class="form-select"
              data-bind="value: Role,
                options: Roles,
                optionsText: (role) => role.value,
                optionsCaption: 'Select...'"
            ></select>
            <button
              type="button"
              class="btn btn-primary"
              data-bind="click: submit,
              enable: Role() && Assignee()"
            >
              Submit
            </button>
          </div>
        </div>
      </div>
    </script>

    <script type="text/html" id="tmpl-request-header">
      <!-- Report.RequestDetailView -->
      <div class="card mb-3 w-100">
        <div class="card-body">
          <h3 class="card-title">Requestor Information</h3>
          <!-- ko if: DisplayMode() == DisplayModes.New -->
          <div class="container-fluid">
            <div class="row">
              <div class="col-6 pb-2">
                <h6>Request Status:</h6>
                <p>Draft</p>
              </div>
            </div>
            <div class="row">
              <div class="col-6 pb-2">
                <label
                  ><h6>Request ID:</h6>
                  <p data-bind="text: ObservableTitle"></p
                ></label>
              </div>
              <div class="col-6 pb-2">
                <div class="form-group">
                  <label><h6>Requestor Office:</h6></label>
                  <select
                    class="form-control"
                    data-bind="value: RequestorInfo.Office,
                options: $root.currentUser.RequestOrgs,
                optionsText: (ro) => ro.Title"
                  ></select>
                  <p>
                    GTM:
                    <span
                      data-bind="text: RequestorInfo.Office()?.GTM?.LookupValue"
                    ></span>
                  </p>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-6 pb-2">
                <h6>Requestor:</h6>
                <div
                  id="people-requestor"
                  data-bind="people: RequestorInfo.Requestor"
                ></div>
              </div>
            </div>
            <div class="row">
              <div class="col-6 pb-2">
                <h6>Requestor Phone:</h6>
                <input
                  type="tel"
                  class="form-control"
                  data-bind="value: RequestorInfo.Phone"
                />
              </div>
              <div class="col-6 pb-2">
                <h6>Requestor Email:</h6>
                <input
                  type="email"
                  class="form-control"
                  class="fluid"
                  data-bind="value: RequestorInfo.Email"
                />
              </div>
              <div class="col-12 pb-2">
                <h6>Service Type:</h6>
                <select
                  class="form-control"
                  class="fluid"
                  data-bind="value: ServiceType,
              options: $root.Config.serviceTypeStore,
              optionsText: (st) => st.Title"
                ></select>
              </div>
            </div>
          </div>
          <!-- /ko -->
          <!-- ko if: DisplayMode() != DisplayModes.New -->
          <div class="container-fluid" data-bind="">
            <div class="row">
              <div class="col-6">
                <h6>Request Status:</h6>
                <p data-bind="text: State.Status"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <h6>Request ID:</h6>
                <p data-bind="text: ObservableTitle"></p>
              </div>
              <div class="col-6">
                <h6>Requestor Office:</h6>
                <p data-bind="text: RequestorInfo.Office()?.Title"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <h6>Requestor:</h6>
                <p data-bind="text: RequestorInfo.Requestor()?.Title"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <h6>Requestor Phone:</h6>
                <p data-bind="text: RequestorInfo.Phone"></p>
              </div>
              <div class="col-6">
                <h6>Requestor Email:</h6>
                <p data-bind="text: RequestorInfo.Email"></p>
              </div>
              <div class="col-6">
                <h6>Submitted Date:</h6>
                <p data-bind="text: Dates.Submitted()?.toLocaleString()"></p>
              </div>
              <div class="col-6">
                <h6>Service Type:</h6>
                <p data-bind="text: ServiceType()?.Title"></p>
              </div>
            </div>
          </div>
          <!-- /ko -->
        </div>
      </div>
    </script>

    <script type="text/html" id="tmpl-service-type-component">
      <div class="card mb-3 w-100" data-bind="using: ServiceTypeComponent">
        <div class="card-body">
          <div class="card-title d-flex justify-content-between">
            <h3 class="mx-0" data-bind="text: ServiceType()?.Title"></h3>
            <i
              class="fa fa-sync pointer"
              data-bind="click: refreshServiceTypeEntity"
            ></i>
          </div>
          <!-- ko if: ServiceType()?.HasTemplate -->
          <!-- ko if: ComponentsAreLoading -->
          <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <!-- /ko -->
          <!-- ko if: !ComponentsAreLoading() && ServiceTypeEntity() -->
          <!-- ko if: IsLoading -->
          <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <!-- /ko -->
          <!-- ko ifnot: IsLoading -->
          <div
            data-bind="template: {name: ElementId, data: ServiceTypeEntity}"
          ></div>
          <!-- /ko -->
          <!-- /ko -->
          <!-- /ko -->
          <div class="col-12 pb-6">
            <label for=""
              ><h6>
                <span
                  data-bind="text: ServiceType()?.DescriptionTitle ?? 'Description'"
                ></span
                >:
              </h6>
            </label>
            <!-- ko if: Request.DisplayMode() != Request.DisplayModes.View -->
            <textarea
              class="form-control"
              data-bind="value: Request.RequestDescription"
            ></textarea>
            <!-- /ko -->
            <!-- ko if: Request.DisplayMode() == Request.DisplayModes.View -->
            <div data-bind="html: Request.RequestDescription"></div>
            <!-- /ko -->
          </div>
        </div>
      </div>
    </script>

    <script type="text/html" id="tmpl-activity-log-component">
      <div class="card">
        <div class="card-body">
          <div class="card-title d-flex justify-content-between">
            <h3 class="mx-0">Approvals and Actions Log</h3>
            <i class="fa fa-sync pointer" data-bind="click: refreshActions"></i>
          </div>
          <div class="position-relative">
            <div class="dimmer" data-bind="css: {'active': IsLoading}">
              <div
                class="d-flex flex-grow-1 align-items-center justify-content-center"
              >
                <div class="spinner-border text-white" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Action Taker</th>
                  <th>Action Type</th>
                  <th>Description</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <!-- ko foreach: Actions -->
                <tr>
                  <td data-bind="text: Author?.Title"></td>
                  <td data-bind="text: ActionType"></td>
                  <td data-bind="html: Description"></td>
                  <td data-bind="text: Created.toLocaleString()"></td>
                </tr>
                <!-- /ko -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </script>
  </div>
  <script
    type="text/javascript"
    src="../Apps/_layouts/15/clienttemplates.js"
  ></script>
  <script
    type="text/javascript"
    src="../Apps/_layouts/15/clientforms.js"
  ></script>
  <script
    type="text/javascript"
    src="../Apps/_layouts/15/clientpeoplepicker.js"
  ></script>
  <script type="text/javascript" src="../Apps/_layouts/15/autofill.js"></script>

  <script src="../SiteAssets/workorder/vendor/knockout/knockout-3.5.0.js"></script>
  <!-- <script src="../SiteAssets/wo/common/KnockoutExtensions.js"></script> -->

  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
  ></script>

  <script defer type="module" src="../SiteAssets/wo/app.js"></script>
</div>
